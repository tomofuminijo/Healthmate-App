# 要件仕様書

## はじめに

Healthmate-App は、4つの独立したHealthmateサービス（Core、HealthManager、CoachAI、Frontend）を統合管理するメタリポジトリです。各サービスの個別デプロイメントを一括で管理し、環境（dev/stage/prod）とリージョンを統一して指定できる機能を提供します。

## 用語集

- **Healthmate-App**: 4つのサービスを束ねる統合管理リポジトリ
- **Service**: Core、HealthManager、CoachAI、Frontendの各個別サービス
- **Environment**: デプロイ環境（dev、stage、prod）
- **Region**: AWSリージョン（例：us-west-2、ap-northeast-1）
- **Deploy_Script**: 一括デプロイスクリプト（deploy_all.sh）
- **Undeploy_Script**: 一括アンデプロイスクリプト（undeploy_all.sh）

## 重要な制約

- **既存サービス非変更原則**: 既存の4つのサービス（Core、HealthManager、CoachAI、Frontend）のコードは一切変更しない
- **メタリポジトリ実装**: 全ての統合機能はHealthmate-App内でのみ実装する
- **既存デプロイスクリプト活用**: 各サービスの既存のデプロイ・アンデプロイスクリプトを呼び出す形で実装する

## 要件

### 要件1

**ユーザーストーリー:** 開発者として、4つのHealthmateサービスを一括でデプロイしたい。そうすることで、個別にデプロイする手間を省き、環境の一貫性を保てる。

#### 受け入れ基準

1. WHEN 開発者が `./deploy_all.sh dev` を実行する THEN システムは4つのサービス（Core、HealthManager、CoachAI、Frontend）をdev環境に順次デプロイする
2. WHEN 開発者が `./deploy_all.sh stage --region ap-northeast-1` を実行する THEN システムは指定されたリージョンでstage環境に4つのサービスをデプロイする
3. WHEN 開発者が `./deploy_all.sh prod` を実行する THEN システムは本番環境に4つのサービスをデプロイする
4. WHEN 開発者が環境を指定せずに `./deploy_all.sh` を実行する THEN システムはデフォルトでdev環境にデプロイする
5. WHEN リージョンが指定されない THEN システムはAWS CLIのデフォルトリージョンを使用する

### 要件2

**ユーザーストーリー:** 開発者として、4つのHealthmateサービスを一括でアンデプロイしたい。そうすることで、不要なリソースを効率的に削除し、コストを節約できる。

#### 受け入れ基準

1. WHEN 開発者が `./undeploy_all.sh dev` を実行する THEN システムは4つのサービスをdev環境から逆順（Frontend→CoachAI→HealthManager→Core）でアンデプロイする
2. WHEN 開発者が `./undeploy_all.sh stage --region ap-northeast-1` を実行する THEN システムは指定されたリージョンでstage環境から4つのサービスをアンデプロイする
3. WHEN 開発者が `./undeploy_all.sh prod` を実行する THEN システムは本番環境から4つのサービスをアンデプロイする
4. WHEN 開発者が環境を指定せずに `./undeploy_all.sh` を実行する THEN システムはデフォルトでdev環境からアンデプロイする
5. WHEN リージョンが指定されない THEN システムはAWS CLIのデフォルトリージョンを使用する

### 要件3

**ユーザーストーリー:** 開発者として、デプロイメントの進行状況とエラーを確認したい。そうすることで、問題が発生した場合に迅速に対応できる。

#### 受け入れ基準

1. WHEN デプロイスクリプトが実行される THEN システムは各サービスのデプロイ開始と完了をログ出力する
2. WHEN いずれかのサービスのデプロイが失敗する THEN システムはエラーメッセージを表示し、スクリプトを停止する
3. WHEN アンデプロイスクリプトが実行される THEN システムは各サービスのアンデプロイ開始と完了をログ出力する
4. WHEN いずれかのサービスのアンデプロイが失敗する THEN システムは警告メッセージを表示するが、他のサービスのアンデプロイは継続する
5. WHEN スクリプトが完了する THEN システムは全体の実行結果サマリーを表示する

### 要件4

**ユーザーストーリー:** 開発者として、Healthmate-Appの全体設計とサービス間の関係を理解したい。そうすることで、効率的に開発とデプロイメントを行える。

#### 受け入れ基準

1. WHEN 開発者がREADME.mdを参照する THEN システムはHealthmate-App全体の設計図を提供する
2. WHEN 開発者がREADME.mdを参照する THEN システムは4つのサービスへのリンク集を提供する
3. WHEN 開発者がREADME.mdを参照する THEN システムはデプロイ順序と依存関係を説明する
4. WHEN 開発者がREADME.mdを参照する THEN システムは使用例とコマンドの説明を提供する
5. WHEN 開発者がREADME.mdを参照する THEN システムは環境変数とリージョン設定の説明を提供する

### 要件5

**ユーザーストーリー:** システム管理者として、デプロイメントの順序が正しく制御されることを確認したい。そうすることで、サービス間の依存関係を維持し、デプロイメントの失敗を防げる。

#### 受け入れ基準

1. WHEN デプロイが実行される THEN システムは必ずCore→HealthManager→CoachAI→Frontendの順序でデプロイする
2. WHEN アンデプロイが実行される THEN システムは必ずFrontend→CoachAI→HealthManager→Coreの順序でアンデプロイする
3. WHEN 前のサービスのデプロイが失敗する THEN システムは後続のサービスのデプロイを実行しない
4. WHEN 各サービスのデプロイが完了する THEN システムは次のサービスのデプロイを開始する前に確認を行う
5. WHEN 全てのサービスのデプロイが完了する THEN システムは統合テストの実行を推奨するメッセージを表示する

### 要件6

**ユーザーストーリー:** 開発者として、異なる環境とリージョンでの設定を柔軟に管理したい。そうすることで、開発、ステージング、本番環境を適切に分離できる。

#### 受け入れ基準

1. WHEN 環境パラメータが指定される THEN システムは各サービスに同じ環境設定を渡す
2. WHEN リージョンパラメータが指定される THEN システムは各サービスに同じリージョン設定を渡す
3. WHEN 無効な環境名が指定される THEN システムはエラーメッセージを表示し、有効な選択肢（dev/stage/prod）を提示する
4. WHEN 無効なリージョン名が指定される THEN システムはエラーメッセージを表示し、AWS CLIの設定確認を促す
5. WHEN 環境変数AWS_REGIONが設定されている THEN システムはリージョン引数が指定されない場合にそれを使用する